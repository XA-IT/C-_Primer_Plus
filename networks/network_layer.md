## 网络层

对于 **转发(forwarding)** 和 **路由选择(routing)** 的区分

### 网络层的功能和服务
- 网络层的主要功能
    - 转发
    - 路由选择
    - 连接建立

    路由选择算法 集中式、分布式
    
- 网络服务模型（可能的服务）
    - 确保交付
    - 有时延上界的确保交付
    - 有序分组交付
    - 确保最小带宽
    - 确保最大时延抖动
    - 安全性服务

    因特网、ATM CBR、ATM ABR
    
虚电路和数据报网络
    网络层一般不会同时提供两种服务
    
虚电路  vc号 维持 **连接状态信息** 网络层中所有参与的路由器都将知道经过的VC

数据报网络 **最长前缀匹配原则** 亦需维护转发状态信息 更新相对不频繁

### 路由器
    - 输入端口
        //->线路端接（物理层）->数据链路处理->查找（转发表）、转发（“匹配加动作”）、排队
    - 交换结构
        - 经内存交换
        - 经总线交换
        - 经互联网络交换（如纵横式网络）
    - 输出端口
    - 排队控制 
        //缓存数量B=平均往返时延RTT*C/根号N N为TCP流
        分组调度程序 主动队列管理 
    - 路由选择控制平面
  
---  
### 转发与编址
- 网络层组成
    - IP协议
    - 路由选择
    - 差错报告以及请求响应

IPv4数据报格式

数据报分片（满足数据链路层的承载容量）

编址
- CIDR 
    - 地址聚合
    - 最长前缀匹配
    - 广播地址255.255.255.255 , 0.0.0.0/8可以表示本网络中的所有主机， 0.0.0.0/32可以用作本机的源地址
- DHCP
    - DHCP服务器发现discover
    - DHCP服务器offer
    - DHCP request
    - DHCP ACK
    - 移动IP

- NAT
    - NAT使能路由器 对外为单一设备，对内仅用于自身地域realm NAT-DHCP
    - NAT转换表 包含端口号与IP地址 端口号长16bit
    - 对于P2P的解决 NAT穿越 UPnP

- ICMP
    - 报文 类型字段 编码字段 -- 差错报告 
    - 

- IPv6

---
### 路由选择算法
- 为发送方到接收方选择最好的网路路径
- 源路由器 —— 目的路由器
- 图G=(N,E)，寻找费用最低的边的集合
    - 全局式路由选择算法
        - 全局状态信息 Link State算法
        - 可能由于拥塞测度算法出现 **路由震荡**
        - 使得每台路由器执行算法时间随机化
    
    - 分布式路由选择算法
        - 距离向量算法
        - Bellmanford 方程 dx(y)=min v {c(x,v)+dv(y)}, x为源节点，v为x的邻居，y为目的节点
        - 链路费用减少，数次迭代即可静止；
        - 链路费用增加，可能会出现 **路由选择环路** packet将在两个节点之间反复 最终出现无穷计数，需等到链路状态发生变化才会修正；  
		- 可以增加毒性逆转，告诉下一跳自己到下下一跳的距离为无穷，可以解决2个节点直接相连的情况，但对于环路仍无效
    - 其他路由选择算法
    
    
- 另一种分法：
    - 静态路由选择算法
    - 动态路由
- 第三种：
    - 负载敏感算法
    - 负载迟钝
    
- 层次路由选择
    - 自治系统AS 在同一as内运行相同路由选择算法——**自治系统内部路由选择协议**
    - AS之间的互联 网关路由器
    - 多个网关路由器：**自治系统间 路由选择协议** 所有AS 采用协议均相同——BGP4
        - 从相邻AS获取可达性信息
        - 向本AS所有路由器传播可达性信息
    - 内部路由器采用 **热土豆路由选择** 来选择最低费用的网关进行路由
        - 只考虑路由器到本AS网关的最短路径
    - AS之间对于可达目的地的通告具有灵活性


### 因特网中的路由选择
- 路由选择信息协议 RIP
    - 一种距离向量协议 路径的最大费用为15
    - 使用RIP相应报文（RIP通告）更新信息，每次30s，一次25个目的子网列表
    - RIP表为路由选择表， 包含距离向量以及转发表， version2 可根据路由（地址）聚合合并表项
    - 180s无新报文即认为邻居不再可达
    - 也可通过报文请求邻居到某一目的地的费用
    - RIP其实是一个应用层的进程，在传输层通过UDP的端口520发送，以实现网络层的功能（QUAGGA.NET）



- 开放最短路径优先 OSPF
    - 核心：洪泛链路状态信息的链路状态协议， Dijkstra最低费用路径算法 
    - 每个路由器在本地计算以自身为根节点的最短路径树 并周期性广播给AS内所有路由器
    - OSPF通告包含在报文中，报文直接由IP承载
    - 主要优点
        - 安全性
        - 允许相同费用路径
        - 对于多播与单播路由的支持
        - 支持单个路由选择域内层次
    - 一个OSPF的AS可配置为多个区域，每个区域有一台或多台区域边界路由器，同时一个AS有一个**主干**区域包含所有边界路由器以及部分非边界路由器。
    - 实践原则 在实践中可能需要预先得到流路由选择从而根据OSPF协议得到相应权重使得希望的路由选择被执行。
    

- **边界网关协议 BGP4**
- BGP基础
    - 从相邻AS获得并在本AS传播子网可达性信息，基于AS策略选择路由，使得每个子网向因特网的其余部分通告自己的存在
    - 路由器通过179端口的半永久TCP连接交换路由选择信息
    - 可分为外部BGP eBGP和内部 iBGP
- BGP路径属性
    - 在BGP会话通告包含一个前缀，含有BGP属性，带属性的前缀为一条路由
    - 两种属性
        - AS-PATH 已经过的AS，避免循环通告或用于其他过滤（**接入策略**）
        - NEXT-HOP 表明一条AS-PATH对应的起始路由器接口IP(?)，方便添加转发表项；根据此值选择适当接口


- BGP路由选择与路由选择策略
    - 最高本地偏好值->最短AS-PATH（AS跳数）->最靠近NEXT-HOP路由器的路由->BGP路由标识符
    - 通过控制BGP路由的通告方式 实现流量控制


### 广播和多播路由选择
- 广播路由算法
    - N次单播
    - 无控制洪泛
        - 广播风暴
    - 受控洪泛
        - 序号控制洪泛  >Gnutella 应用层实现
        - 反向路径转发 RPF >仅转发来自从源出发最短单播路径的分组
        
    - 生成树广播
        - 避免接收冗余分组， 费用最小的为最小生成树
        - 复杂性在于其生成和维护
        - e.g. 基于中心的方法，先定义一个中心节点，其他节点向其单播tree-join 广播
    - 实践中通过TTL或年龄（age）限制洪泛，LSA检测冗余和区分新旧
    

- 多播  
    - 使用间接地址，使之传播到多播组中，其与单播地址独立
    - 通过因特网组网管理协议IGMPv3
        - 封装于IP数据报内，三种状态membership\_query, membership\_report, leave_group(非强制)
            - 由于一种 **软状态** ，即若未被显式更新则通过超时事件删除
    - 多播路由选择
        - 使用生成树
        - 使用受控洪泛
            - 对于下游路由器无加入多播组的主机的情况，使用 剪枝 向上游路由器报告
    - 因特网中的 多播路由选择
        - DVMRP 具有剪枝的RFP
        - 协议无关的多播路由选择协议PIM，分为稠密和稀疏两种模式，在稀疏模式中使用聚集点建立多播分发树